<!DOCTYPE html>
<html>
	<style>
	img {
	    	max-width: 1920px;
		max-height: 1080px;
		height: auto;
		width: auto;
	}
	</style>
    <head>
        <link href={{ static_url("css/bootstrap.min.css") }} rel="stylesheet">
        <title>Board</title>
        {% block head %} 

        {% end %}
    </head>
    <body>
        <center>
            <img src="{{ static_url("img/"+files[0]) }}" name="pic" border=0>
            <script>
            </script>
        </center>
	<script type="text/javascript" src={{ static_url("js/jquery-3.1.1.min.js") }}></script>
        <script>
			
		var index = 0;
		var countt = 0;
		var imgs = ["{{static_url("img/"+files[0]) }}","{{static_url("img/"+files[0]) }}"];
		var timee = [5, 5];
		var tmp_gain = 0;
		var schedule_dir_txt = '/home/tim/Desktop/broadcast/';

	
		function inc_schedule()
		{
			$.ajaxSetup({
			    beforeSend: function (jqXHR, settings)  {
				type = settings.type
				if (type != 'GET' && type != 'HEAD' && type != 'OPTIONS' ) {
				     var pattern = /(.+; *)?_xsrf *= *([^;" ]+)/ ;
				     var xsrf = pattern.exec( document.cookie);
				     if (xsrf) {
					jqXHR.setRequestHeader( 'X-Xsrftoken' , xsrf[ 2 ]);
				    }
				}
			}});

			var data =
			{
				"dirr": schedule_dir_txt,
				"modee": 1
			};
			var dataToSend = JSON.stringify(data);
			var pattern = /(.+; *)?_xsrf *= *([^;" ]+)/ ;
			var xsrf = pattern.exec( document.cookie);
			if (xsrf) 
			{
				dataToSend._xsrf = xsrf[3];
			}
			tmp_gain = 0;

			$.ajax({
					url: '/db_schedule',
					type: 'POST',
					contentType : 'application/json',
					data: dataToSend,
					success: function (jsonResponse)
					{
						var objresponse = JSON.parse(jsonResponse);
						tmp_gain = objresponse['num'];
						if (tmp_gain > 0)
						{
							console.log('inc_schedule scuess');
						}
					},
					error: function (xhr, textStatus, error) 
					{
						console.log(xhr.statusText);
						console.log(textStatus);
						console.log(error);
						console.log("img_schedule error");
					}
		       		 });
		}
	
		function next_schedule()
		{
			$.ajaxSetup({
			    beforeSend: function (jqXHR, settings)  {
				type = settings.type
				if (type != 'GET' && type != 'HEAD' && type != 'OPTIONS' ) {
				     var pattern = /(.+; *)?_xsrf *= *([^;" ]+)/ ;
				     var xsrf = pattern.exec( document .cookie);
				     if (xsrf) {
					jqXHR.setRequestHeader( 'X-Xsrftoken' , xsrf[ 2 ]);
				    }
				}
			}});
			var data =
			{
			    "dirr": schedule_dir_txt
			};
			var dataToSend = JSON.stringify(data);
			var pattern = /(.+; *)?_xsrf *= *([^;" ]+)/ ;
			var xsrf = pattern.exec( document.cookie);
			if (xsrf) 
			{
				dataToSend._xsrf = xsrf[3];
			}
			var tmp_dir = "";
			var tmp_time = 5;
			var tmp_pass = 0;
			
			$.ajax({
				url: '/txt_schedule',
				type: 'POST',
				contentType : 'application/json',
				data: dataToSend,
				success: function (jsonResponse) 
				{
					var objresponse = JSON.parse(jsonResponse);
					//console.log(objresponse['anss']);
					tmp_dir = '/static/'+objresponse['anss'][0];
					tmp_time = objresponse['anss'][1];
					tmp_pass = objresponse['anss'][2];
					if(index==1)
					{
						imgs[0] = tmp_dir;
						timee[0] = tmp_time;
					}
					else if(index==0)
					{
						imgs[1] = tmp_dir;
						timee[1] = tmp_time;
					}

					if (tmp_pass == 0)
					{
						console.log("call inc_schedule");
						inc_schedule();
					}
				},
				error: function (xhr, textStatus, error) 
				{
					console.log(xhr.statusText);
					console.log(textStatus);
					console.log(error);
					console.log("load_schedule error");
					tmp_dir = "{{static_url("img/0.jpg")}}";
					tmp_time = 5;
					tmp_pass = 0;
					if(index==1)
					{
						imgs[0] = tmp_dir;
						timee[0] = tmp_time;
					}
					else if(index==0)
					{
						imgs[1] = tmp_dir;
						timee[1] = tmp_time;
					}
				}
			});
			
		
		}

		function slideshow()
		{
			console.log(imgs[0]);
			console.log(imgs[1]);
			index = (index + 1) % 2;
			$('img[name="pic"]').attr("src",imgs[index]);
			console.log("change");
			//document.pic.height = window.screen.height;
			//document.pic.width = window.screen.width;
		    }
	
		function timerr()
		{
			if(countt % timee[index] == timee[index]-1)
			{
				next_schedule();
				slideshow();
			}
		
			countt = (countt+1) % 60;
		}
	
	
		window.setInterval(timerr,1000);
            //$(document).ready(function(){
            //    setInterval(timerr,1000);
            //});
        </script>
    </body>
</html>
